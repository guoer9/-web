<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教师数据分析仪表盘 - 师生互动系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <style>
        .chart-container {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 1rem;
            color: #6c757d;
        }
        
        .date-range-selector {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">师生互动系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/teacher/dashboard">教师主页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/teacher/analytics">数据分析</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/teacher/resources">教学资源</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <span class="navbar-text me-3">欢迎，<span id="teacher-name"></span></span>
                    <button class="btn btn-outline-light" id="logout-btn">登出</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 class="mb-4">教学数据分析仪表盘</h1>
        
        <!-- 日期范围选择器 -->
        <div class="row date-range-selector">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text">日期范围</span>
                    <input type="date" class="form-control" id="start-date">
                    <span class="input-group-text">至</span>
                    <input type="date" class="form-control" id="end-date">
                    <button class="btn btn-primary" id="apply-date-filter">应用</button>
                </div>
            </div>
        </div>
        
        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <div class="stat-icon text-primary">
                        <i class="bi bi-question-circle"></i>
                    </div>
                    <div class="stat-value" id="total-questions">0</div>
                    <div class="stat-label">总问题数</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <div class="stat-icon text-success">
                        <i class="bi bi-bar-chart"></i>
                    </div>
                    <div class="stat-value" id="total-polls">0</div>
                    <div class="stat-label">总投票数</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <div class="stat-icon text-info">
                        <i class="bi bi-chat-dots"></i>
                    </div>
                    <div class="stat-value" id="total-discussions">0</div>
                    <div class="stat-label">总讨论数</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <div class="stat-icon text-warning">
                        <i class="bi bi-star"></i>
                    </div>
                    <div class="stat-value" id="avg-rating">0.0</div>
                    <div class="stat-label">平均评分</div>
                </div>
            </div>
        </div>
        
        <!-- 图表区域 -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h4>互动类型分布</h4>
                    <img id="interaction-type-chart" class="img-fluid" src="" alt="互动类型分布图">
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h4>反馈情感分析</h4>
                    <img id="sentiment-chart" class="img-fluid" src="" alt="反馈情感分析图">
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="chart-container">
                    <h4>互动时间线</h4>
                    <img id="interaction-timeline-chart" class="img-fluid" src="" alt="互动时间线图">
                </div>
            </div>
        </div>
        
        <!-- 学生参与度表格 -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="chart-container">
                    <h4>学生参与度排名</h4>
                    <div class="table-responsive">
                        <table class="table table-striped" id="student-engagement-table">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>学生姓名</th>
                                    <th>问题数</th>
                                    <th>投票参与</th>
                                    <th>讨论参与</th>
                                    <th>反馈提交</th>
                                    <th>总互动数</th>
                                    <th>参与度分数</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 学生参与度数据将在这里动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 当前教师信息
        let currentTeacher = null;
        let currentClassId = null;
        
        // 页面加载时执行
        document.addEventListener('DOMContentLoaded', function() {
            // 检查用户登录状态
            checkLoginStatus();
            
            // 初始化日期选择器为最近30天
            setDefaultDateRange();
            
            // 绑定事件处理器
            document.getElementById('apply-date-filter').addEventListener('click', loadAnalyticsData);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        });
        
        // 设置默认日期范围为最近30天
        function setDefaultDateRange() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('end-date').valueAsDate = endDate;
            document.getElementById('start-date').valueAsDate = startDate;
        }
        
        // 检查用户登录状态
        function checkLoginStatus() {
            // 从localStorage获取用户信息
            const teacherJson = localStorage.getItem('teacher');
            if (!teacherJson) {
                // 未登录，重定向到登录页面
                window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                return;
            }
            
            try {
                currentTeacher = JSON.parse(teacherJson);
                document.getElementById('teacher-name').textContent = currentTeacher.name;
                
                // 默认使用第一个班级的ID
                if (currentTeacher.classes && currentTeacher.classes.length > 0) {
                    currentClassId = currentTeacher.classes[0].id;
                }
                
                // 加载分析数据
                loadAnalyticsData();
            } catch (error) {
                console.error('解析用户信息出错', error);
                window.location.href = '/login';
            }
        }
        
        // 加载分析数据
        function loadAnalyticsData() {
            if (!currentTeacher) return;
            
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            // 加载仪表盘汇总数据
            loadDashboardSummary(startDate, endDate);
            
            // 加载互动报告
            loadInteractionReport(startDate, endDate);
            
            // 加载学生参与度数据
            if (currentClassId) {
                loadStudentEngagement(currentClassId, startDate, endDate);
            }
        }
        
        // 加载仪表盘汇总数据
        function loadDashboardSummary(startDate, endDate) {
            const url = `/api/analytics/dashboard-summary?teacher_id=${currentTeacher.id}` + 
                        (startDate ? `&start_date=${startDate}` : '') +
                        (endDate ? `&end_date=${endDate}` : '');
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        updateDashboardUI(data.summary);
                    } else {
                        console.error('加载仪表盘数据失败', data.error);
                    }
                })
                .catch(error => {
                    console.error('加载仪表盘数据出错', error);
                    showError('加载分析数据失败，请稍后重试。');
                });
        }
        
        // 加载互动报告
        function loadInteractionReport(startDate, endDate) {
            const url = `/api/analytics/interaction-report?teacher_id=${currentTeacher.id}` + 
                        (startDate ? `&start_date=${startDate}` : '') +
                        (endDate ? `&end_date=${endDate}` : '');
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.report) {
                        // 更新互动时间线图表
                        if (data.report.charts && data.report.charts.interaction_timeline) {
                            document.getElementById('interaction-timeline-chart').src = 
                                'data:image/png;base64,' + data.report.charts.interaction_timeline;
                        }
                    }
                })
                .catch(error => {
                    console.error('加载互动报告出错', error);
                });
        }
        
        // 加载学生参与度数据
        function loadStudentEngagement(classId, startDate, endDate) {
            const url = `/api/analytics/student-engagement?class_id=${classId}` + 
                        (startDate ? `&start_date=${startDate}` : '') +
                        (endDate ? `&end_date=${endDate}` : '');
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.engagement_data) {
                        updateStudentEngagementTable(data.engagement_data);
                    }
                })
                .catch(error => {
                    console.error('加载学生参与度数据出错', error);
                });
        }
        
        // 更新仪表盘UI
        function updateDashboardUI(summary) {
            // 更新统计卡片
            document.getElementById('total-questions').textContent = 
                summary.interaction_summary.total_questions;
            document.getElementById('total-polls').textContent = 
                summary.interaction_summary.total_polls;
            document.getElementById('total-discussions').textContent = 
                summary.interaction_summary.total_discussions;
            document.getElementById('avg-rating').textContent = 
                summary.feedback_summary.average_rating.toFixed(1);
            
            // 更新图表
            if (summary.charts.interaction_distribution) {
                document.getElementById('interaction-type-chart').src = 
                    'data:image/png;base64,' + summary.charts.interaction_distribution;
            }
            
            if (summary.charts.sentiment_distribution) {
                document.getElementById('sentiment-chart').src = 
                    'data:image/png;base64,' + summary.charts.sentiment_distribution;
            }
        }
        
        // 更新学生参与度表格
        function updateStudentEngagementTable(engagementData) {
            const tableBody = document.getElementById('student-engagement-table').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            engagementData.forEach((student, index) => {
                const row = tableBody.insertRow();
                
                row.insertCell(0).textContent = index + 1;  // 排名
                row.insertCell(1).textContent = student.student_name;
                row.insertCell(2).textContent = student.question_count;
                row.insertCell(3).textContent = student.poll_participation;
                row.insertCell(4).textContent = student.discussion_participation;
                row.insertCell(5).textContent = student.feedback_submission;
                row.insertCell(6).textContent = student.total_interactions;
                
                // 参与度分数单元格
                const scoreCell = row.insertCell(7);
                scoreCell.textContent = student.engagement_score;
                
                // 根据分数添加颜色提示
                if (student.engagement_score >= 80) {
                    scoreCell.classList.add('text-success', 'fw-bold');
                } else if (student.engagement_score >= 50) {
                    scoreCell.classList.add('text-warning', 'fw-bold');
                } else {
                    scoreCell.classList.add('text-danger', 'fw-bold');
                }
            });
            
            if (engagementData.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 8;
                cell.textContent = '暂无学生参与数据';
                cell.classList.add('text-center');
            }
        }
        
        // 显示错误消息
        function showError(message) {
            alert(message);  // 简单实现，实际项目中可以使用更友好的UI组件
        }
        
        // 处理登出
        function handleLogout() {
            localStorage.removeItem('teacher');
            window.location.href = '/login';
        }
    </script>
</body>
</html> 